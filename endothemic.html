<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>化學反應線性迴歸分析模型</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Prop Types (修復 Recharts 依賴錯誤 #1) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo } = React;
        const { ScatterChart, Scatter, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts || {};

        // --- Gemini API Utilities ---
        const API_KEY = ""; // 實際的 API 密鑰將在執行時提供
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        // 帶有指數退避策略的 fetch 函數
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error("API call failed after max retries:", error);
                        throw error;
                    }
                }
            }
        }

        // 呼叫 Gemini API 進行內容生成
        async function generateContent(prompt, systemInstruction) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                // 使用 Google Search 工具來確保化學知識和背景資訊是準確的
                tools: [{ "google_search": {} }], 
            };
            
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(`${API_URL}?key=${API_KEY}`, options);
                const result = await response.json();
                
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "無法生成報告。請檢查 API 連線。";
            } catch (error) {
                return "生成報告時發生嚴重錯誤。";
            }
        }

        // --- Icons (Lucide React equivalents) ---
        const FlaskConical = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>
        );
        const Calculator = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
        );
        const LineChartIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"/><path d="M18 17l-4.5-4.5-4.5 4.5L5 9"/></svg>
        );
        const Trash2 = ({ className }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        );


        function ChemicalReactionLab() {
            // --- Constants (化學計量常數) ---
            const MOLAR_MASS_ACID = 60.05; // 醋酸 (CH3COOH) 
            const MOLAR_MASS_SODA = 84.01; // 梳打粉 (NaHCO3)
            const ACID_CONCENTRATION = 0.05; // 假設白醋濃度 5%

            // --- State Variables ---
            // Input Fields for Current Experiment
            const [vinegar, setVinegar] = useState(50); // mL
            const [bakingSoda, setBakingSoda] = useState(5); // g
            const [temp0, setTemp0] = useState(25.0); 
            const [temp30, setTemp30] = useState(23.5); 
            const [temp60, setTemp60] = useState(22.0); 
            
            // Input Fields for Prediction
            const [predVinegar, setPredVinegar] = useState(150);
            const [predSoda, setPredSoda] = useState(15);
            
            // Data Storage
            const [experiments, setExperiments] = useState([]); // Array of {X, Y, ...}
            const [activeExperimentId, setActiveExperimentId] = useState(null);

            // LLM State
            const [llmAnalysis, setLlmAnalysis] = useState(null);
            const [isGeneratingAnalysis, setIsGeneratingAnalysis] = useState(false);

            // --- Helpers: Stoichiometry and Feature Engineering ---
            const calculateEffectiveMoles = (v, s) => {
                const acidMass = v * 1.0; 
                const pureAcidMass = acidMass * ACID_CONCENTRATION;
                const molesAcid = pureAcidMass / MOLAR_MASS_ACID;
                const molesSoda = s / MOLAR_MASS_SODA;
                
                // Reaction ratio is 1:1
                const isAcidLimiting = molesAcid < molesSoda;
                const limitingMoles = isAcidLimiting ? molesAcid : molesSoda;
                
                const totalMass = acidMass + s; // Total mass of mixture (approximation)

                // The feature for regression (X)
                // X = Limiting Moles / Total Mass (Effective Molar Concentration relative to mixture size)
                const featureX = totalMass > 0 ? (limitingMoles / totalMass) : 0; 

                return {
                    limitingMoles,
                    totalMass,
                    limitingName: isAcidLimiting ? '醋 (醋酸)' : '梳打粉 (碳酸氫鈉)',
                    featureX: featureX,
                };
            };

            // --- Linear Regression Logic (useMemo to re-calculate only when experiments change) ---
            const linearModel = useMemo(() => {
                if (experiments.length < 2) {
                    return { slope: 0, intercept: 0, R2: 0, modelData: [], ready: false };
                }

                const N = experiments.length;
                let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;

                experiments.forEach(exp => {
                    const X = exp.featureX;
                    const Y = exp.tempDrop; // Y is the target variable (Delta T)
                    sumX += X;
                    sumY += Y;
                    sumXY += X * Y;
                    sumX2 += X * X;
                });

                const meanX = sumX / N;
                const meanY = sumY / N;

                // Calculate SSxx and SSxy
                let SSxx = 0, SSxy = 0, SStt = 0;
                experiments.forEach(exp => {
                    SSxx += (exp.featureX - meanX) ** 2;
                    SSxy += (exp.featureX - meanX) * (exp.tempDrop - meanY);
                    SStt += (exp.tempDrop - meanY) ** 2;
                });

                // Calculate Slope (a) and Intercept (b)
                const slope = SSxx !== 0 ? SSxy / SSxx : 0;
                const intercept = meanY - slope * meanX;

                // Calculate R-squared (R2) for goodness of fit
                let SSres = 0;
                experiments.forEach(exp => {
                    const Y_pred = slope * exp.featureX + intercept;
                    SSres += (exp.tempDrop - Y_pred) ** 2;
                });
                const R2 = SStt !== 0 ? (1 - SSres / SStt) : 1;


                // Prepare data for plotting the regression line
                const minX = Math.min(...experiments.map(e => e.featureX));
                const maxX = Math.max(...experiments.map(e => e.featureX));
                const modelData = [
                    { X: minX * 0.9, Y: slope * (minX * 0.9) + intercept },
                    { X: maxX * 1.1, Y: slope * (maxX * 1.1) + intercept }
                ];

                return { slope, intercept, R2, modelData, ready: true };
            }, [experiments]);


            // --- Actions ---
            const addExperiment = () => {
                const calculations = calculateEffectiveMoles(vinegar, bakingSoda);
                const startTemp = parseFloat(temp0);
                const endTemp = parseFloat(temp60);
                const tempDrop = startTemp - endTemp;
                
                // Note: The reaction CH3COOH + NaHCO3 is typically endothermic (absorbs heat, so temperature drops, ΔT > 0).

                const newExp = {
                    id: Date.now(),
                    vinegar,
                    bakingSoda,
                    temp0: startTemp,
                    temp60: endTemp,
                    tempDrop, // This is the Y variable for regression
                    ...calculations, // featureX is the X variable for regression
                    chartData: [
                        { time: 0, temp: startTemp },
                        { time: 30, temp: parseFloat(temp30) },
                        { time: 60, temp: endTemp }
                    ]
                };

                setExperiments([newExp, ...experiments]);
                setActiveExperimentId(newExp.id);
                setLlmAnalysis(null); // Clear analysis when a new experiment is added

                // Reset inputs for next experiment
                setTemp0(25.0);
                setTemp30(24.0);
                setTemp60(23.0);
            };

            const removeExperiment = (id) => {
                const filtered = experiments.filter(e => e.id !== id);
                setExperiments(filtered);
                if (activeExperimentId === id) {
                    setActiveExperimentId(filtered.length > 0 ? filtered[0].id : null);
                    setLlmAnalysis(null);
                }
            };

            const setActiveExperimentIdWrapper = (id) => {
                setActiveExperimentId(id);
                setLlmAnalysis(null); // Clear analysis when changing selection
            };

            // --- Gemini API Function: Generate Analysis ---
            const generateAnalysis = async (experiment) => {
                setIsGeneratingAnalysis(true);
                setLlmAnalysis("正在生成化學分析報告...");

                const userPrompt = `
                    分析以下化學實驗結果：
                    反應物：醋 (5% 醋酸溶液) 和梳打粉 (碳酸氫鈉)。
                    化學方程式：CH3COOH + NaHCO3 -> CH3COONa + H2O + CO2 (吸熱反應).
                    
                    實驗參數和結果：
                    1. 醋用量: ${experiment.vinegar} mL
                    2. 梳打粉用量: ${experiment.bakingSoda} g
                    3. 初始溫度 (T0): ${experiment.temp0}°C
                    4. 最終溫度 (T60): ${experiment.temp60}°C
                    5. 實際溫差 (ΔT): ${experiment.tempDrop.toFixed(2)}°C
                    6. 限制反應物: ${experiment.limitingName}
                    7. 模型特徵 (X, 限制莫耳濃度/總質量): ${experiment.featureX.toFixed(5)}

                    請根據這些數據，寫一份詳細的化學實驗報告。報告應包含以下內容：
                    1. 反應物和反應類型的簡要化學背景。
                    2. 對實際溫差 (ΔT) 的解釋，以及這與吸熱反應性質的關係。
                    3. 對限制反應物作用的分析。
                    4. 根據結果提出至少兩點實驗操作或數據收集過程中可能存在的誤差來源。
                    報告必須是中文（繁體），並且格式良好，可以直接閱讀。
                `;
                
                const systemPrompt = "你是一位資深的化學實驗室導師和數據分析師。你的任務是提供一份專業、清晰且易於理解的化學實驗結果分析報告。報告風格應具備學術嚴謹性，並使用繁體中文。";

                try {
                    const analysisText = await generateContent(userPrompt, systemPrompt);
                    setLlmAnalysis(analysisText);
                } catch (error) {
                    setLlmAnalysis("生成報告時發生錯誤。請檢查網路連線或 API 狀態。");
                    console.error("Gemini API Error:", error);
                } finally {
                    setIsGeneratingAnalysis(false);
                }
            };


            // --- Prediction Logic ---
            const predictionResult = useMemo(() => {
                if (!linearModel.ready) return null;
                
                const calcs = calculateEffectiveMoles(predVinegar, predSoda);
                const X_new = calcs.featureX;
                
                // Predict Y (Delta T)
                let predictedDrop = linearModel.slope * X_new + linearModel.intercept;
                
                // Ensure prediction is not ridiculously negative (i.e., less than 0 drop)
                if (predictedDrop < 0) predictedDrop = 0; 
                
                return {
                    drop: predictedDrop,
                    limitingName: calcs.limitingName,
                    featureX: X_new,
                };
            }, [linearModel, predVinegar, predSoda]);

            // Prepare chart data for the currently selected experiment
            const currentExp = useMemo(() => experiments.find(e => e.id === activeExperimentId), [experiments, activeExperimentId]);


            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans">
                <div className="max-w-7xl mx-auto space-y-8">
                    
                    {/* Header */}
                    <header className="bg-white p-6 rounded-2xl shadow-md border-l-8 border-indigo-600">
                        <h1 className="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
                            <LineChartIcon className="text-indigo-600 w-8 h-8" />
                            化學反應線性迴歸分析模型
                        </h1>
                        <p className="text-slate-500 mt-2">
                            輸入多組實驗數據，訓練出預測溫差 ($-\Delta T$) 的線性模型
                        </p>
                    </header>

                    <div className="grid grid-cols-1 xl:grid-cols-12 gap-8">
                        
                        {/* LEFT COLUMN: Data Entry & List (5 cols) */}
                        <div className="xl:col-span-5 space-y-6">
                            
                            {/* 1. Add New Experiment */}
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <h2 className="text-lg font-bold text-slate-700 mb-6 flex items-center gap-2 border-b pb-2">
                                    <FlaskConical className="w-5 h-5 text-indigo-500" /> 
                                    新增實驗數據 (Data Point)
                                </h2>
                                
                                <div className="space-y-5">
                                    {/* Reactants */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <label className="text-xs font-bold text-slate-500 uppercase">醋 (mL)</label>
                                            <input 
                                                type="number" step="10" value={vinegar} onChange={(e) => setVinegar(Number(e.target.value))}
                                                className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-indigo-900"
                                            />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-xs font-bold text-slate-500 uppercase">梳打粉 (g)</label>
                                            <input 
                                                type="number" step="1" value={bakingSoda} onChange={(e) => setBakingSoda(Number(e.target.value))}
                                                className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-indigo-900"
                                            />
                                        </div>
                                    </div>

                                    {/* Temperatures */}
                                    <div className="space-y-2">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">量度溫度 (°C)</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            <div>
                                                <span className="text-xs text-slate-400 block mb-1">0秒 (初始)</span>
                                                <input 
                                                    type="number" step="0.1" value={temp0} onChange={(e) => setTemp0(e.target.value)}
                                                    className="w-full border border-slate-300 rounded text-center py-1 text-sm"
                                                    placeholder="初始"
                                                />
                                            </div>
                                            <div>
                                                <span className="text-xs text-slate-400 block mb-1">30秒</span>
                                                <input 
                                                    type="number" step="0.1" value={temp30} onChange={(e) => setTemp30(e.target.value)}
                                                    className="w-full border border-slate-300 rounded text-center py-1 text-sm"
                                                    placeholder="過程"
                                                />
                                            </div>
                                            <div>
                                                <span className="text-xs text-slate-400 block mb-1">60秒 (最終)</span>
                                                <input 
                                                    type="number" step="0.1" value={temp60} onChange={(e) => setTemp60(e.target.value)}
                                                    className="w-full border border-slate-300 rounded text-center py-1 text-sm"
                                                    placeholder="最終"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <button 
                                        onClick={addExperiment}
                                        disabled={!temp0 || !temp60}
                                        className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-md transition-all active:scale-95 disabled:bg-indigo-400"
                                    >
                                        紀錄並分析 (實驗 #{experiments.length + 1})
                                    </button>
                                </div>
                            </div>

                            {/* 2. Experiment List */}
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 max-h-[400px] overflow-y-auto">
                                <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                                    <FlaskConical className="w-5 h-5 text-slate-400" /> 
                                    歷史實驗記錄 ({experiments.length} 組數據)
                                </h2>
                                
                                {experiments.length === 0 ? (
                                    <div className="text-center py-8 text-slate-400 text-sm bg-slate-50 rounded-lg border border-dashed border-slate-200">
                                        請在上方新增實驗數據
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {experiments.map((exp, idx) => (
                                            <div 
                                                key={exp.id}
                                                onClick={() => setActiveExperimentIdWrapper(exp.id)}
                                                className={`p-3 rounded-xl border cursor-pointer transition-all ${
                                                    activeExperimentId === exp.id 
                                                    ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-500' 
                                                    : 'border-slate-200 hover:border-indigo-300 hover:bg-slate-50'
                                                }`}
                                            >
                                                <div className="flex justify-between items-start mb-2">
                                                    <span className="font-bold text-slate-700 text-sm">實驗 #{experiments.length - idx}</span>
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-xs font-semibold px-2 py-0.5 rounded ${exp.tempDrop > 0 ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>
                                                            {exp.tempDrop > 0 ? '吸熱' : '放熱'}
                                                        </span>
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); removeExperiment(exp.id); }}
                                                            className="text-slate-400 hover:text-red-500 p-1"
                                                        >
                                                            <Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-y-1 text-xs text-slate-600">
                                                    <div>溫差 (<span className="text-red-600 font-bold">ΔT</span>): <span className="font-bold">{exp.tempDrop.toFixed(2)}°C</span></div>
                                                    <div>限制物: {exp.limitingName.split(' ')[0]}</div>
                                                    <div className="col-span-2">模型特徵 (<span className="text-indigo-600 font-bold">X</span>): {exp.featureX.toFixed(5)}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* RIGHT COLUMN: Analysis, Chart & Prediction (7 cols) */}
                        <div className="xl:col-span-7 space-y-6">
                            
                            {/* Linear Regression Chart */}
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                <h2 className="text-lg font-bold text-slate-700 mb-6 flex items-center gap-2">
                                    <LineChartIcon className="w-5 h-5 text-indigo-500" /> 
                                    線性迴歸模型視覺化 ($X$ vs $\Delta T$)
                                </h2>
                                
                                <div className="h-[300px] w-full bg-slate-50 rounded-xl p-2 border border-slate-100">
                                    {experiments.length >= 2 ? (
                                        <ResponsiveContainer width="100%" height="100%">
                                            <LineChart data={linearModel.modelData} margin={{ top: 20, right: 30, left: 10, bottom: 20 }}>
                                                <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                                                <XAxis 
                                                    dataKey="X" 
                                                    type="number"
                                                    domain={['auto', 'auto']}
                                                    label={{ value: '限制莫耳濃度 X (mol/g)', position: 'insideBottom', offset: -10, fill: '#64748b' }} 
                                                    tickFormatter={(tick) => tick.toExponential(1)}
                                                    stroke="#94a3b8"
                                                />
                                                <YAxis 
                                                    dataKey="Y" 
                                                    type="number"
                                                    domain={['auto', 'auto']}
                                                    label={{ value: '溫差 ΔT (°C)', angle: -90, position: 'insideLeft', fill: '#64748b' }} 
                                                    stroke="#94a3b8"
                                                />
                                                <Tooltip 
                                                    contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                                                    formatter={(value, name) => [value.toFixed(3), name === 'X' ? '限制莫耳濃度' : '溫差']}
                                                />
                                                <Legend verticalAlign="top" height={36}/>
                                                
                                                {/* Scatter Plot of Actual Data */}
                                                <Scatter data={experiments.map(e => ({ X: e.featureX, Y: e.tempDrop }))} name="實測數據點" fill="#4f46e5" shape="circle" />
                                                
                                                {/* Regression Line */}
                                                <Line type="monotone" dataKey="Y" stroke="#ef4444" strokeWidth={2} dot={false} name={`迴歸線 (R²: ${linearModel.R2.toFixed(3)})`} legendType="line" />
                                            </LineChart>
                                        </ResponsiveContainer>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-400">
                                            <p>需要至少 **兩組** 數據才能進行線性迴歸分析</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">

                                {/* Model Summary / Active Experiment Chart */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                    <h3 className="text-lg font-bold text-slate-700 mb-4">當前實驗數據曲線</h3>
                                    <div className="h-[200px] w-full bg-slate-50 rounded-xl p-2 border border-slate-100">
                                        {currentExp ? (
                                            <ResponsiveContainer width="100%" height="100%">
                                                <LineChart data={currentExp.chartData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                                                    <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                                                    <XAxis dataKey="time" type="number" stroke="#94a3b8" />
                                                    <YAxis domain={['auto', 'auto']} stroke="#94a3b8" />
                                                    <Line type="monotone" dataKey="temp" name="溫度" stroke="#0e7490" strokeWidth={2} dot={{ r: 4 }} />
                                                    <Tooltip formatter={(value) => [`${value.toFixed(1)}°C`, '溫度']} />
                                                </LineChart>
                                            </ResponsiveContainer>
                                        ) : (
                                            <div className="h-full flex flex-col items-center justify-center text-slate-400 text-sm">
                                                請選擇左側記錄查看 0-60s 曲線
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Prediction Model Section */}
                                <div className="bg-gradient-to-br from-indigo-700 to-indigo-900 p-6 rounded-2xl shadow-lg text-white">
                                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-white">
                                        <Calculator className="w-5 h-5 text-yellow-400" /> 
                                        模型預測模擬器
                                    </h2>

                                    {linearModel.ready ? (
                                        <div className="space-y-4">
                                            
                                            {/* Model Info */}
                                            <div className="text-xs text-indigo-200">
                                                <p>模型公式: ΔT ≈ {linearModel.slope.toFixed(2)} * X + {linearModel.intercept.toFixed(2)}</p>
                                                <p>擬合度 (R²): {linearModel.R2.toFixed(3)}</p>
                                            </div>

                                            <div className="grid grid-cols-2 gap-4">
                                                {/* Prediction Inputs */}
                                                <div className="space-y-1">
                                                    <label className="text-xs font-bold text-indigo-200 uppercase">預測：醋 (mL)</label>
                                                    <input 
                                                        type="number" value={predVinegar} onChange={(e) => setPredVinegar(Number(e.target.value))}
                                                        className="w-full bg-indigo-700 border border-indigo-600 rounded-lg px-3 py-2 text-white outline-none focus:border-yellow-400 transition-colors"
                                                    />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-xs font-bold text-indigo-200 uppercase">預測：梳打粉 (g)</label>
                                                    <input 
                                                        type="number" value={predSoda} onChange={(e) => setPredSoda(Number(e.target.value))}
                                                        className="w-full bg-indigo-700 border border-indigo-600 rounded-lg px-3 py-2 text-white outline-none focus:border-yellow-400 transition-colors"
                                                    />
                                                </div>
                                            </div>

                                            {/* Prediction Result */}
                                            <div className="bg-yellow-500/10 border border-yellow-500/20 p-3 rounded-xl flex flex-col items-center justify-center text-center">
                                                <span className="text-yellow-200 text-xs uppercase font-bold mb-1">預測溫度下降 (-ΔT)</span>
                                                <span className="text-3xl font-bold text-yellow-400">
                                                    {predictionResult.drop.toFixed(1)}°C
                                                </span>
                                                <span className="text-xs text-yellow-100/70 mt-1">
                                                    限制反應物: {predictionResult.limitingName.split(' ')[0]}
                                                </span>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-6 text-slate-400">
                                            需要至少 **兩組** 數據才能啟動預測模型。
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* LLM Analysis Section */}
                            {currentExp && (
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-purple-300">
                                    <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                                        ✨ Gemini AI 實驗結果分析
                                    </h2>

                                    <button
                                        onClick={() => generateAnalysis(currentExp)}
                                        disabled={isGeneratingAnalysis}
                                        className="w-full py-2 mb-4 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold shadow transition-all active:scale-95 disabled:bg-purple-400 flex items-center justify-center gap-2"
                                    >
                                        {isGeneratingAnalysis ? (
                                            <>
                                                <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                正在分析...
                                            </>
                                        ) : (
                                            <>
                                                ✨ 生成化學分析報告 (實驗 #{experiments.length - experiments.findIndex(e => e.id === activeExperimentId)})
                                            </>
                                        )}
                                    </button>

                                    <div className="mt-4 p-4 bg-purple-50 rounded-xl text-slate-700 text-sm whitespace-pre-wrap min-h-[150px]">
                                        {llmAnalysis || "點擊按鈕，使用 AI 導師獲取當前實驗結果的詳細化學解釋和誤差分析。"}
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChemicalReactionLab />);
    </script>
</body>
</html>